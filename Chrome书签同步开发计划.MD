# Chrome书签同步开发计划

## 1. 项目概述

### 1.1 项目背景
随着用户使用Chrome浏览器的时间增长，书签数量不断增加，用户需要一种有效的方式来管理和备份这些书签数据。本项目旨在开发一个功能，将Chrome浏览器的书签同步到飞书多维表格中，实现书签数据的集中管理和备份。

### 1.2 项目目标
开发一个Chrome扩展功能，能够：
1. 获取用户的Chrome书签数据
2. 将书签数据同步到飞书多维表格
3. 提供用户友好的界面进行配置和操作

## 2. 功能需求分析

### 2.1 核心功能

#### 2.1.1 书签数据获取
- 获取用户Chrome浏览器的所有书签
- 支持获取书签的标题、URL、创建时间、文件夹结构等信息
- 支持增量同步，只同步新增或修改的书签

#### 2.1.2 飞书多维表格同步
- 将书签数据同步到指定的飞书多维表格
- 支持配置独立的书签数据表ID
- 提供同步状态反馈

#### 2.1.3 用户配置
- 在飞书配置区域添加书签数据表ID配置项
- 支持测试书签同步连接

### 2.2 辅助功能

#### 2.2.1 同步状态管理
- 显示最近同步时间
- 显示同步状态（成功/失败）
- 提供手动同步按钮

#### 2.2.2 错误处理
- 网络错误处理
- 飞书API错误处理
- 权限错误处理

## 3. 技术实现方案

### 3.1 数据结构设计

#### 3.1.1 书签数据结构
```json
{
  "title": "书签标题",
  "url": "书签URL",
  "folder": "书签所在文件夹",
  "createdTime": "创建时间",
  "lastModified": "最后修改时间"
}
```

#### 3.1.2 飞书多维表格字段映射
| 书签字段 | 飞书表格列名 |
|---------|------------|
| title | 书签标题 |
| url | 书签URL |
| folder | 所在文件夹 |
| createdTime | 创建时间 |
| lastModified | 最后修改时间 |
| syncTime | 同步时间 |

### 3.2 接口设计

#### 3.2.1 Chrome书签API
使用Chrome提供的`chrome.bookmarks` API获取书签数据：
```javascript
chrome.bookmarks.getTree(function(bookmarkTreeNodes) {
  // 处理书签数据
});
```

#### 3.2.2 飞书多维表格API
使用飞书开放平台的多维表格API进行数据写入：
```http
POST https://open.feishu.cn/open-apis/bitable/v1/apps/{app_token}/tables/{table_id}/records
```

### 3.3 界面设计

#### 3.3.1 配置界面
在飞书配置标签页中添加：
- 书签数据表ID输入框
- 测试书签同步连接按钮

#### 3.3.2 操作界面
在主界面添加：
- 书签同步标签页
- 全量同步按钮
- 增量同步按钮
- 导出书签按钮
- 同步状态显示区域

## 4. 开发任务分解

### 4.1 前端界面开发

#### 4.1.1 修改sidebar.html
- 在飞书配置区域添加书签数据表ID输入框
- 添加书签同步标签页及相关UI元素

#### 4.1.2 修改sidebar.js
- 添加书签数据表ID相关元素引用
- 实现书签同步标签页的切换逻辑
- 实现全量同步、增量同步、导出书签按钮的事件处理
- 实现书签同步状态显示功能

### 4.2 后台功能开发

#### 4.2.1 修改background.js
- 添加处理书签同步消息的逻辑
- 实现获取Chrome书签数据的功能
- 实现书签数据同步到飞书多维表格的功能
- 实现全量同步和增量同步两种模式

#### 4.2.2 增量书签识别方式
为了实现增量同步功能，我们需要采用以下方式来识别新增或修改的书签：

1. **基于时间戳的增量识别**：
   - 记录上次同步完成的时间戳
   - 获取所有书签时，比较书签的`dateAdded`和`dateGroupModified`字段与上次同步时间
   - `dateAdded`表示书签创建时间，`dateGroupModified`表示书签或其父文件夹的最后修改时间
   - 同步所有`dateAdded`或`dateGroupModified`大于上次同步时间的书签

2. **基于书签ID的增量识别**：
   - 维护一个已同步书签ID的本地存储列表
   - 获取当前所有书签ID并与已同步列表进行比较
   - 同步新增的书签（存在于当前书签中但不存在于已同步列表中）
   - 对于已存在的书签，比较其`dateGroupModified`时间来判断是否需要更新

3. **混合识别策略**：
   - 结合时间戳和书签ID两种方式实现更可靠的增量识别
   - 首选时间戳方式，因为它更高效
   - 当检测到时间戳可能不可靠时（如系统时间变更），回退到基于ID的方式

4. **本地存储设计**：
   - 使用`chrome.storage.local`存储上次同步时间戳
   - 存储已同步书签ID列表（用于辅助识别）
   - 存储同步配置和状态信息

### 4.3 配置管理

#### 4.3.1 扩展配置
- 在存储中添加书签数据表ID配置项
- 实现配置的保存和加载功能

## 5. 详细开发计划

### 5.1 第一阶段：界面开发（预计2天）

#### 第1天：配置界面开发
- 修改sidebar.html，添加书签数据表ID输入框
- 修改sidebar.js，添加相关元素引用和配置保存逻辑
- 实现配置的加载和保存功能

#### 第2天：操作界面开发
- 修改sidebar.html，添加书签同步标签页
- 修改sidebar.js，实现标签页切换逻辑
- 实现同步按钮和导出按钮的UI和基本事件处理

### 5.2 第二阶段：后台功能开发（预计3天）

#### 第3天：书签数据获取功能
- 修改background.js，实现获取Chrome书签数据的功能
- 实现书签数据的解析和处理
- 添加错误处理机制

#### 第4天：飞书同步功能开发
- 修改background.js，实现书签数据同步到飞书的功能
- 实现飞书API调用和数据格式转换
- 添加同步状态反馈机制

#### 第5天：同步模式实现
- 实现全量同步功能
- 实现增量同步功能
- 添加同步模式选择逻辑

### 5.3 第三阶段：集成测试和优化（预计2天）

#### 第6天：功能集成测试
- 测试书签数据获取功能
- 测试飞书同步功能
- 测试全量同步和增量同步模式

#### 第7天：优化和完善
- 优化用户界面交互
- 完善错误处理和提示信息
- 编写用户文档和开发文档

## 6. 关键技术点

### 6.1 Chrome书签API使用
- 使用`chrome.bookmarks.getTree()`获取完整的书签树结构
- 遍历书签树，提取需要的书签信息
- 处理书签文件夹结构

### 6.2 飞书API集成
- 使用飞书开放平台的认证机制获取访问令牌
- 调用多维表格API进行数据写入
- 处理API响应和错误情况

### 6.3 增量同步实现
- 记录上次同步时间
- 比较书签的最后修改时间，只同步新增或修改的书签
- 实现同步状态的持久化存储

## 7. 风险评估和应对措施

### 7.1 技术风险

#### 7.1.1 Chrome书签API权限问题
- 风险描述：用户可能未授权书签访问权限
- 应对措施：在manifest.json中正确配置permissions，并在界面中提供权限说明

#### 7.1.2 飞书API调用限制
- 风险描述：飞书API可能有调用频率限制
- 应对措施：实现批量同步和重试机制，避免频繁调用API

#### 7.1.3 大量书签数据处理性能问题
- 风险描述：用户书签数量过多时，处理和同步可能较慢
- 应对措施：实现分批处理和进度显示，提升用户体验

### 7.2 用户体验风险

#### 7.2.1 同步时间过长影响用户体验
- 风险描述：大量书签同步可能需要较长时间
- 应对措施：提供进度显示和后台同步功能

#### 7.2.2 数据同步冲突
- 风险描述：多设备或多用户同时操作可能导致数据冲突
- 应对措施：实现数据版本控制和冲突解决机制

## 8. 测试计划

### 8.1 功能测试
- 测试书签数据获取功能
- 测试飞书同步功能
- 测试全量同步和增量同步模式
- 测试配置保存和加载功能

### 8.2 性能测试
- 测试大量书签数据的处理性能
- 测试同步时间与书签数量的关系
- 测试网络异常情况下的重试机制

### 8.3 兼容性测试
- 测试不同版本Chrome浏览器的兼容性
- 测试不同操作系统下的兼容性

## 9. 部署和发布

### 9.1 本地测试
- 在开发环境中进行全面测试
- 验证所有功能是否正常工作

### 9.2 用户测试
- 邀请部分用户进行测试
- 收集用户反馈并进行优化

### 9.3 正式发布
- 更新扩展版本号
- 提交到Chrome Web Store
- 发布更新说明

## 10. 后续优化计划

### 10.1 功能优化
- 支持书签分类同步到不同数据表
- 支持书签搜索和过滤功能
- 支持定时自动同步功能

### 10.2 性能优化
- 优化书签数据处理算法
- 提升同步效率
- 减少内存占用

### 10.3 用户体验优化
- 提供更丰富的同步状态信息
- 支持同步历史记录查看
- 提供数据统计和分析功能